# 功能规范：自动文档大纲提取与主题映射

**版本**: 1.0.0
**创建日期**: 2026-01-04
**状态**: 草稿

## 澄清记录

### Session 2026-01-04 (Second)

- Q: 业务模块识别的文件统计范围是什么？ → A: 只统计源代码文件（.py/.js/.tsx，排除 **test**、**tests**、**__pycache__** 等测试和配置目录）
- Q: 信息提取失败时的降级策略是什么？ → A: 分层降级：README → pyproject.toml/package.json → 代码 Docstring → 通用模板
- Q: Monorepo 和多模块项目的处理方式是什么？ → A: 自动检测 Monorepo 结构，为每个子项目生成独立文档集
- Q: 技术栈检测完全失败时的行为是什么？ → A: 生成基础必需文档（快速开始、项目概述等）+ 检测警告 + 手动配置指南
- Q: 大型项目的并发处理策略是什么？ → A: 全串行处理（避免并发问题和资源竞争）
- Q: 核心逻辑的实现位置是什么？ → A: 开发独立的 Claude Code Agent 或 Skill 来处理文档生成（不创建 core/ Python 模块）

### Session 2026-01-04 (First)

（保留第一轮的 5 个问题记录）

---

## 1. 功能概述

### 1.1 简短名称
`auto-doc-outline`

### 1.2 功能描述
通过分析实际项目的 Wiki 文档生成示例（dingtalk-sdk-generator 和 dingtalk-notable-connect），总结文档生成逻辑，优化 `/wiki-generate` 命令，使其能够：
1. **自动提取项目文档大纲**：基于代码库结构自动识别应该生成哪些文档主题
2. **智能主题映射**：根据项目特性（技术栈、规模、架构）确定每个主题应该生成哪些具体文档
3. **分层文档结构**：生成按功能模块组织的分层目录结构
4. **自适应内容深度**：根据模块复杂度生成适当的子文档层级

### 1.3 业务价值
- **减少手动配置**：自动识别项目需要哪些文档，无需用户手动配置
- **提升文档完整性**：确保不遗漏重要的功能模块和架构文档
- **适应不同项目规模**：小型项目生成扁平结构，大型项目生成深层嵌套结构
- **提高文档可维护性**：生成的文档结构反映代码架构，便于后续维护
- **降低使用门槛**：新用户直接运行命令即可获得完整文档结构

---

## 2. 参考文档分析

### 2.1 dingtalk-sdk-generator 文档结构

**项目特点**：OpenAPI SDK 生成器，命令行工具

**文档分类**：
```
zh/content/
├── 快速入门.md              # 入门指南
├── 项目概述.md              # 项目介绍
├── CLI命令参考.md           # CLI 工具文档（特有）
├── 核心架构/                # 架构文档
│   ├── 核心架构.md
│   ├── 模板渲染/            # 子功能模块
│   ├── 模型生成/            # 子功能模块
│   ├── API生成/             # 子功能模块
│   ├── OpenAPI解析.md       # 关键组件
│   └── 批处理协调.md        # 关键组件
├── 代码生成/                # 核心功能
│   ├── 代码生成.md
│   ├── 模型生成/            # 子功能（深层嵌套）
│   │   ├── 类型推断机制/
│   │   ├── 模型生成架构/
│   │   └── 依赖关系管理/
│   └── API生成/             # 子功能
│       ├── 同步API生成.md
│       └── 异步API生成.md
├── 多语言支持/              # 跨领域功能
│   ├── 多语言支持.md
│   ├── PHP语言支持.md
│   └── Python语言支持.md
├── 高级特性/                # 高级功能
│   ├── 高级特性.md
│   ├── 扩展点.md
│   ├── 模板自定义/          # 子功能
│   └── 依赖管理.md
├── OpenAPI规范支持/         # 技术标准
│   ├── OpenAPI规范支持.md
│   ├── OpenAPI解析机制.md
│   ├── 类型映射策略.md
│   ├── 组件处理.md
│   └── 验证规则.md
├── API参考/                 # API 文档（业务相关）
│   ├── API参考.md
│   ├── 用户管理API.md
│   ├── 部门管理API.md
│   └── ...
├── 测试策略/                # 质量保障
│   ├── 测试策略.md
│   ├── 单元测试.md
│   ├── 集成测试.md
│   ├── 回归测试.md
│   └── 性能测试.md
└── 贡献指南.md              # 社区相关
```

**文档层级模式**：
- 一级：核心主题（快速入门、项目概述）
- 二级：功能模块（代码生成、核心架构）
- 三级：子功能（模型生成、API生成）
- 四级：详细机制（类型推断机制、依赖关系管理）

**特殊文档**：
- CLI命令参考.md（CLI 工具特有）
- API参考/（业务 API 文档，按业务领域分组）

### 2.2 dingtalk-notable-connect 文档结构

**项目特点**：全栈 Web 应用（Streamlit），数据库集成工具

**文档分类**：
```
zh/content/
├── 快速开始.md              # 入门指南
├── 项目概述.md              # 项目介绍
├── 技术栈与依赖.md          # 技术选型（必需）
├── 数据模型/                # 数据层（数据库项目）
│   ├── 数据模型.md
│   ├── 表映射模型.md
│   ├── 导入日志模型.md
│   ├── 审计日志模型.md
│   ├── 数据库连接模型.md
│   └── 字段映射模型.md
├── 系统架构设计/            # 架构文档
│   ├── 系统架构设计.md
│   ├── 整体架构.md
│   ├── 数据流/              # 子主题
│   │   ├── 数据流.md
│   │   ├── 配置数据流.md
│   │   ├── 查询数据流.md
│   │   └── 执行数据流.md
│   ├── 数据库设计/          # 子主题
│   │   ├── 数据库设计.md
│   │   ├── 配置数据库架构.md
│   │   └── 目标数据库架构.md
│   ├── 状态管理/            # 子主题（UI 相关）
│   │   ├── 状态管理.md
│   │   ├── 页面状态管理/
│   │   └── 向导状态管理/
│   └── 可扩展性设计/        # 子主题
│       ├── 可扩展性设计.md
│       ├── 数据源扩展性设计.md
│       └── 目标数据库扩展性设计.md
├── 数据库连接管理/          # 核心功能模块
│   ├── 数据库连接管理.md
│   ├── 连接配置/            # 子功能
│   │   ├── 连接配置.md
│   │   ├── 连接表单设计.md
│   │   ├── 连接模型定义.md
│   │   └── 连接验证逻辑.md
│   ├── 连接存储与加密/      # 子功能（深层嵌套）
│   │   ├── 连接存储与加密.md
│   │   ├── 数据库连接数据模型.md
│   │   ├── 数据库加密存储设计.md
│   │   └── 加密密钥管理/
│   └── 连接测试/            # 子功能
│       ├── 连接测试.md
│       ├── 后端连接验证逻辑.md
│       ├── 前端连接测试交互.md
│       └── 连接测试实现细节.md
├── 字段映射配置/            # 核心功能模块
│   ├── 字段映射配置.md
│   ├── 映射向导流程.md
│   ├── 数据类型映射.md
│   ├── 字段映射校验.md
│   └── 表结构生成.md
├── 数据导入执行/            # 核心功能模块
│   ├── 数据导入执行.md
│   ├── ETL流程执行.md
│   ├── 表结构差异检测.md
│   ├── 表结构生成（DDL）.md
│   └── 导入日志记录.md
├── 数据查看器/              # UI 功能模块
│   ├── 数据查看器.md
│   ├── 基础浏览功能.md
│   └── 高级查询功能/        # 子功能（深层嵌套）
│       ├── 高级查询功能.md
│       ├── 高级过滤功能.md
│       ├── 分页与性能优化.md
│       ├── 文本搜索功能.md
│       └── 数组字段格式化显示.md
├── 导入历史与配置管理/      # 管理功能
│   ├── 导入历史与配置管理.md
│   ├── 导入历史记录.md
│   └── 配置文件管理.md
├── 操作审计日志/            # 业务功能模块
│   ├── 操作审计日志.md
│   ├── 审计日志UI展示.md
│   ├── 变更追踪机制/
│   ├── 审计日志数据模型/
│   └── 审计服务API/
├── 开发指南/                # 开发相关
│   ├── 开发指南.md
│   ├── 开发环境搭建.md
│   ├── 代码贡献流程.md
│   ├── 调试技巧与日志管理.md
│   ├── 编码规范与静态检查.md
│   └── 测试编写规范/
├── 部署指南/                # 部署相关
│   ├── 部署指南.md
│   ├── 本地Docker部署.md
│   ├── Kubernetes部署.md
│   ├── 生产环境优化部署.md
│   └── 部署最佳实践.md
├── 测试策略/                # 测试相关
│   ├── 测试策略.md
│   ├── 测试夹具与配置.md
│   ├── 单元测试.md
│   ├── 集成测试.md
│   └── 契约测试.md
├── 故障排除/                # 问题解决
│   ├── 故障排除.md
│   ├── 数据库连接问题.md
│   ├── 数据导入失败.md
│   ├── 临时表相关问题.md
│   ├── 界面状态同步问题.md
│   └── 日志诊断方法.md
└── 安全考虑/                # 安全相关
    ├── 安全考虑.md
    ├── 密钥管理实践.md
    ├── 配置安全.md
    ├── 数据加密机制.md
    └── 应用层安全.md
```

**文档层级模式**：
- 一级：核心主题（快速开始、项目概述）
- 二级：功能模块（数据库连接管理、字段映射配置）
- 三级：子功能（连接配置、连接存储与加密）
- 四级：详细机制（加密密钥管理、加密服务实现机制）

### 2.3 文档生成规律总结

**共性规律**：

1. **必需文档**（所有项目都生成）：
   - 快速开始/快速入门
   - 项目概述
   - 技术栈与依赖
   - 系统架构设计（或核心架构）
   - 开发指南
   - 部署指南
   - 测试策略
   - 故障排除
   - 安全考虑

2. **条件文档**（根据项目特性生成）：
   - 数据模型/（检测到 SQLAlchemy/Django ORM）
   - API 文档/（检测到 FastAPI/Flask/OpenAPI）
   - CLI 命令参考.md（检测到 Click/Typer CLI）
   - 任务队列/（检测到 Celery/RQ）
   - 前端相关/（检测到 React/Vue/Streamlit）
   - 消息队列/（检测到 Kafka/RabbitMQ）

3. **业务模块文档**（基于代码结构自动识别）：
   - 每个 `src/services/` 或 `app/services/` 下的服务生成对应文档
   - 每个 `pages/` 或 `app/pages/` 下的页面模块生成对应文档
   - 每个 API 路由分组生成对应 API 文档

4. **文档层级深度规则**：
   - 小模块（< 5 文件）：生成 1 级文档（主题.md）
   - 中型模块（5-20 文件）：生成 2 级文档（主题/子主题.md）
   - 大型模块（> 20 文件）：生成 3-4 级文档（主题/子主题/详细机制.md）

5. **文档命名模式**：
   - 根目录：序号-文档名.md（00-快速开始.md、01-项目概述.md）
   - 子目录：中文目录名 + 索引文档（主题/主题.md）
   - 深层嵌套：层级递进（主题/子主题/机制.md）

---

## 3. 用户场景与测试

### 3.1 场景 1：新项目自动生成完整文档

**用户背景**：
- 开发者创建新的 Python Web 项目
- 使用 FastAPI + SQLAlchemy + React
- 项目结构包含多个服务和模块

**操作步骤**：
1. 运行 `wiki-generator --init` 初始化配置
2. 在 Claude Code 中运行 `/wiki-generate --full`

**预期结果**：
- 自动检测到 FastAPI → 生成 `API 文档/API 接口.md`
- 自动检测到 SQLAlchemy → 生成 `数据模型/数据模型.md`
- 自动检测到 React → 生成 `前端架构/前端架构.md`
- 自动识别 `src/services/` 下的服务 → 生成对应的业务模块文档
- 生成 3-4 层深度的文档结构（对于大型服务模块）

**验收标准**：
- 生成的文档结构覆盖所有主要功能模块
- 每个文档包含正确的 `<cite>` 引用和目录
- 大型模块（>20 文件）生成 3-4 层子文档
- 文档命名使用中文，符合规范

### 3.2 场景 2：CLI 工具项目自动识别

**用户背景**：
- 开发者创建命令行工具项目
- 使用 Click 框架
- 有多个子命令

**操作步骤**：
1. 运行 `wiki-generator --init` 初始化配置
2. 在 Claude Code 中运行 `/wiki-generate --full`

**预期结果**：
- 自动检测到 Click CLI → 生成 `CLI命令参考.md`
- 生成每个子命令的文档章节
- 不生成 Web 相关文档（API 文档、前端架构等）

**验收标准**：
- CLI 命令参考包含所有子命令说明
- 每个命令有使用示例
- 文档结构扁平（CLI 工具通常较简单）

### 3.3 场景 3：中型项目自适应深度

**用户背景**：
- 开发者创建中型数据处理项目
- 有 5-10 个核心模块
- 每个模块 5-15 个文件

**操作步骤**：
1. 运行 `wiki-generator --init` 初始化配置
2. 在 Claude Code 中运行 `/wiki-generate --full`

**预期结果**：
- 为每个核心模块生成 2 级文档（模块/模块.md + 模块/子功能.md）
- 不生成过深的 3-4 层结构（避免文档过于复杂）
- 为每个模块生成架构图（Mermaid）

**验收标准**：
- 每个模块文档包含子功能列表
- 文档深度适中（2-3 层）
- 架构图清晰展示模块关系

---

## 4. 功能需求

### FR-01: 自动检测项目技术栈

**需求描述**：
系统应能够通过静态分析项目代码，自动检测使用的技术栈和框架，并据此决定生成哪些条件文档。

**检测规则**（扩充 v2.0 规则）：

| 检测规则 | 触发条件 | 生成文档 |
|---------|---------|---------|
| **后端框架** |
| FastAPI | `from fastapi` 或 `import fastapi` | `API 文档/API 接口.md` |
| Flask | `from flask` | `API 文档/API 接口.md` |
| Django | `from django` | `API 文档/Django视图.md`、`数据模型/数据模型.md` |
| **ORM** |
| SQLAlchemy | `from sqlalchemy` 或 `import sqlalchemy` | `数据模型/数据模型.md` |
| Django ORM | `from django.db` | `数据模型/Django模型.md` |
| Tortoise ORM | `from tortoise` | `数据模型/Tortoise模型.md` |
| **CLI 框架** |
| Click | `import click` 或 `from click` | `CLI命令参考.md` |
| Typer | `import typer` 或 `from typer` | `CLI命令参考.md` |
| argparse | `import argparse` | `CLI命令参考.md` |
| **前端框架** |
| React | `package.json` 包含 `react` | `前端架构/前端架构.md` |
| Vue | `package.json` 包含 `vue` | `前端架构/前端架构.md` |
| Streamlit | `import streamlit` | `前端架构/Streamlit应用.md` |
| **任务队列** |
| Celery | `from celery` 或 `import celery` | `任务队列/任务队列.md` |
| RQ | `import rq` | `任务队列/任务队列.md` |
| **消息队列** |
| Kafka | `import kafka` 或 `from kafka` | `消息队列/消息队列.md` |
| RabbitMQ | `import pika` | `消息队列/消息队列.md` |
| **测试框架** |
| pytest | `import pytest` | `测试策略.md`（必需） |
| unittest | `import unittest` | `测试策略.md`（必需） |
| **数据库** |
| PostgreSQL | 检测到 `psycopg2` 或 `asyncpg` | `数据库设计/数据库设计.md` |
| MySQL | 检测到 `pymysql` 或 `mysqlclient` | `数据库设计/数据库设计.md` |
| MongoDB | 检测到 `pymongo` | `数据库设计/数据库设计.md` |
| **缓存** |
| Redis | `import redis` | `缓存策略/缓存策略.md` |
| Memcached | `import memcache` | `缓存策略/缓存策略.md` |
| **容器化** |
| Dockerfile | 文件存在 | `部署指南/Docker部署.md`（必需） |
| docker-compose | 文件存在 | `部署指南/Docker Compose部署.md` |
| Kubernetes | `k8s/` 或 `kubernetes/` 目录存在 | `部署指南/Kubernetes部署.md` |
| **API 规范** |
| OpenAPI | `.yaml` 或 `.json` 文件包含 `openapi:` | `API文档/OpenAPI规范.md` |
| GraphQL | `import graphql` 或 `from graphql` | `API文档/GraphQL接口.md` |
| gRPC | `import grpc` | `API文档/gRPC服务.md` |

**验收标准**：
- ✅ 检测准确率 ≥ 95%（在已知技术栈上）
- ✅ 检测时间 < 5 秒（中型项目）
- ✅ 支持同时检测多个技术栈
- ✅ 生成文档不重复（FastAPI 和 SQLAlchemy 只生成一份 API 文档和一份数据模型文档）

**检测失败处理**：
- 当检测到的技术栈数量 < 3 时，生成警告提示用户可能遗漏重要技术栈
- 提供手动配置指南，指导用户如何在 `wiki-config.json` 中补充技术栈信息
- 始终生成基础必需文档（快速开始、项目概述、开发指南、部署指南、测试策略、故障排除、安全考虑）

### FR-02: 自动识别业务模块结构

**需求描述**：
系统应能够分析项目的目录结构，自动识别业务模块，并为每个模块生成对应的文档。

**识别规则**：

1. **服务层识别**：
   - 扫描 `src/services/`、`app/services/`、`services/` 目录
   - 每个 `.py` 文件（非 `__init__.py`）视为一个服务
   - 生成文档路径：`业务模块/{服务名}服务.md`

2. **页面层识别**（Web 应用）：
   - 扫描 `pages/`、`app/pages/`、`src/pages/` 目录
   - 每个 `.py` 或 `.tsx` 文件视为一个页面模块
   - 生成文档路径：`UI模块/{页面名}页面.md`

3. **API 路由识别**：
   - 扫描 `api/`、`routers/`、`views/` 目录
   - 按路由文件分组（如 `user_routes.py` → 用户管理 API）
   - 生成文档路径：`API文档/{业务领域}API.md`

4. **模型层识别**：
   - 扫描 `models/`、`src/models/` 目录
   - 每个 ORM 模型类生成一个子文档
   - 生成文档路径：`数据模型/{模型名}模型.md`

5. **Monorepo 结构识别**：
   - 检测 `packages/`、`apps/`、`workspaces/` 目录或 `pnpm-workspace.yaml`、`nx.json` 配置文件
   - 为每个子项目生成独立文档集（如 `docs/package-a/`、`docs/package-b/`）
   - 每个子项目独立应用技术栈检测和模块识别规则

**文件统计范围**：
- **只统计源代码文件**：`.py`、`.js`、`.tsx`、`.ts`、`.jsx` 等
- **排除目录**：`test/`、`tests/`、`__pycache__/`、`.pytest_cache/`、`node_modules/`、`dist/`、`build/` 等
- **排除文件**：`__init__.py`、测试文件（`*_test.py`、`test_*.py`）、配置文件（`*.config.js`、`*.json`，但 `package.json` 和 `pyproject.toml` 除外）

**模块规模评估**：

| 文件数量 | 层级深度 | 生成策略 |
|---------|---------|---------|
| 1-4 文件 | 1 层 | 只生成索引文档（模块/模块.md） |
| 5-20 文件 | 2 层 | 生成索引 + 子功能文档（模块/模块.md、模块/子功能.md） |
| 21-50 文件 | 3 层 | 生成索引 + 子功能 + 机制文档（模块/子功能/机制.md） |
| >50 文件 | 4 层 | 生成完整层级（模块/子功能/类别/详细机制.md） |

**验收标准**：
- ✅ 模块识别覆盖率 ≥ 90%（识别所有主要业务模块）
- ✅ 模块命名清晰（使用中文业务术语）
- ✅ 层级深度合理（避免过深或过浅）
- ✅ 生成时间 < 30 秒（大型项目）

### FR-03: 自适应文档内容深度

**需求描述**：
系统应根据模块的复杂度和规模，自动调整生成文档的内容深度和详细程度。

**内容深度规则**：

**小型模块**（1-4 文件）：
```
模块名称.md
├── 简介（1-2 段）
├── 主要功能（列表）
├── 核心组件（表格）
└── 相关文件链接（<cite>）
```

**中型模块**（5-20 文件）：
```
模块名称.md
├── 简介（2-3 段）
├── 项目结构（Mermaid 图）
├── 核心组件（详细说明）
├── 主要功能（带代码示例）
├── 依赖关系分析
├── 使用示例
└── 相关文件链接（<cite>）

子功能1.md
子功能2.md
...
```

**大型模块**（21-50 文件）：
```
模块名称.md
├── 简介（详细）
├── 项目结构（多层次 Mermaid 图）
├── 核心组件（分层说明）
├── 详细组件分析（每个组件独立章节）
├── 依赖关系分析
├── 数据流/状态管理
├── 性能考虑
├── 故障排查指南
└── 相关文件链接（<cite>）

子功能/
├── 子功能.md
├── 机制1.md
├── 机制2.md
...
```

**超大型模块**（>50 文件）：
```
模块名称.md（索引文档）
├── 简介
├── 架构总览
├── 模块列表（链接到子文档）
└── 快速导航

类别1/
├── 类别.md
├── 子模块1.md
├── 子模块2.md
└── 详细机制/
    ├── 机制1.md
    ├── 机制2.md
    ...
类别2/
...
```

**验收标准**：
- ✅ 文档长度合理（小型 < 500 行，中型 500-2000 行，大型 2000-5000 行）
- ✅ 内容详细程度匹配模块复杂度
- ✅ 避免信息过载（大型模块拆分为多个子文档）
- ✅ 提供清晰的导航（目录索引、交叉引用）

### FR-04: 自动生成文档索引和导航

**需求描述**：
系统应自动生成文档索引文件（README.md 或 INDEX.md），提供完整的文档导航。

**索引结构**：

```markdown
# 文档索引

## 快速开始
- [快速开始](../快速开始.md) - 5 分钟上手指南

## 项目概述
- [项目概述](../项目概述.md) - 项目介绍和核心目标

## 核心功能模块

### 数据库连接管理
- [数据库连接管理](数据库连接管理/数据库连接管理.md)
  - [连接配置](数据库连接管理/连接配置/连接配置.md)
  - [连接存储与加密](数据库连接管理/连接存储与加密/连接存储与加密.md)
  - [连接测试](数据库连接管理/连接测试/连接测试.md)

### 字段映射配置
- [字段映射配置](字段映射配置/字段映射配置.md)
  - [映射向导流程](字段映射配置/映射向导流程.md)
  - [数据类型映射](字段映射配置/数据类型映射.md)
  - [字段映射校验](字段映射配置/字段映射校验.md)
  - [表结构生成](字段映射配置/表结构生成.md)

...

## 技术文档
- [技术栈与依赖](../技术栈与依赖.md)
- [系统架构设计](../系统架构设计/系统架构设计.md)
- [数据模型](../数据模型/数据模型.md)

## 开发相关
- [开发指南](../开发指南/开发指南.md)
- [测试策略](../测试策略/测试策略.md)

## 部署与运维
- [部署指南](../部署指南/部署指南.md)
- [故障排除](../故障排除/故障排除.md)
- [安全考虑](../安全考虑/安全考虑.md)

---

**生成时间**: {{DATE}}
**项目版本**: {{VERSION}}
**文档版本**: {{DOC_VERSION}}
```

**验收标准**：
- ✅ 索引包含所有生成的文档
- ✅ 索引按逻辑分组（快速开始、核心功能、技术文档等）
- ✅ 提供文档简短描述（1 句话）
- ✅ 链接正确可点击

### FR-05: 智能文档内容生成

**需求描述**：
系统应根据检测到的项目信息，自动填充文档的具体内容，而非空白模板。

**内容生成规则**：

**信息提取降级策略**（按优先级）：
1. **README.md**：提取项目名称、描述、核心功能列表
2. **配置文件**：从 `pyproject.toml`、`package.json`、`setup.py` 提取元数据
3. **代码 Docstring**：从主模块、类、函数的文档字符串提取功能说明
4. **代码注释**：提取关键逻辑的行内注释
5. **通用模板**：使用预设的通用模板作为兜底方案

**项目概述**：
```markdown
## 简介
{{PROJECT_NAME}} 是一个 {{PROJECT_TYPE}}，旨在 {{PROJECT_GOAL}}。

该项目的核心功能包括：
- {{FEATURE_1}}（从 README.md 提取）
- {{FEATURE_2}}（从代码注释提取）
- {{FEATURE_3}}（从配置文件推测）

**Section sources**
- [README.md](file://README.md#L1-L50)
- [src/main.py](file://src/main.py#L1-L30)
```

**技术栈与依赖**：
```markdown
## 后端技术栈
- **语言**: Python {{PYTHON_VERSION}}（从 .python-version 或 runtime.txt 提取）
- **框架**: {{FRAMEWOK}}（自动检测 FastAPI/Django/Flask）
- **ORM**: {{ORM}}（自动检测 SQLAlchemy/Django ORM）
- **数据库**: {{DATABASE}}（从依赖检测 psycopg2/pymysql）

## 前端技术栈
- **框架**: {{FRONTEND}}（自动检测 React/Vue/Streamlit）
- **状态管理**: {{STATE_MANAGEMENT}}（检测 Redux/Zustand）
- **UI 库**: {{UI_LIB}}（检测 MUI/Ant Design）

## 开发依赖
- **测试**: pytest {{VERSION}}（从 pyproject.toml 提取）
- **代码质量**: ruff {{VERSION}}（从 pyproject.toml 提取）
- **类型检查**: mypy {{VERSION}}（从 pyproject.toml 提取）

**Section sources**
- [pyproject.toml](file://pyproject.toml)
- [package.json](file://package.json)
```

**数据模型**（检测到 SQLAlchemy）：
```markdown
## 简介
本项目使用 SQLAlchemy ORM 进行数据持久化。以下是项目中定义的所有数据模型。

## 模型列表
| 模型名 | 表名 | 说明 | 文件位置 |
|--------|------|------|----------|
| User | users | 用户模型 | src/models/user.py |
| DatabaseConnection | database_connections | 数据库连接 | src/models/database.py |
| {{MODEL_NAME}} | {{TABLE_NAME}} | {{DESCRIPTION}} | {{FILE_PATH}} |

## 详细模型文档
- [User模型](User模型.md)
- [DatabaseConnection模型](DatabaseConnection模型.md)
...

**Section sources**
- [src/models/__init__.py](file://src/models/__init__.py)
- [src/models/user.py](file://src/models/user.py)
```

**API 文档**（检测到 FastAPI）：
```markdown
## API 概览
本项目提供 {{ENDPOINT_COUNT}} 个 REST API 端点，分为以下功能模块：

| 模块 | 端点数量 | 基础路径 | 说明 |
|------|---------|---------|------|
| 用户管理 | 5 | /api/users | 用户 CRUD 操作 |
| 数据库连接 | 3 | /api/connections | 连接管理 |
| {{MODULE}} | {{COUNT}} | {{BASE_PATH}} | {{DESCRIPTION}} |

## 详细 API 文档
- [用户管理 API](用户管理API.md)
- [数据库连接 API](数据库连接API.md)
...

**Section sources**
- [src/api/users.py](file://src/api/users.py)
- [src/api/connections.py](file://src/api/connections.py)
```

**验收标准**：
- ✅ 内容自动填充率 ≥ 70%（减少用户手动编辑）
- ✅ 提取的信息准确（从正确的源文件提取）
- ✅ 生成的内容格式规范（Markdown 格式正确）
- ✅ 引用的文件路径正确（`file://` 协议）

---

## 5. 成功标准

### 5.1 功能完整性
- ✅ 支持检测 20+ 常见技术栈和框架（后端、前端、数据库、队列等）
- ✅ 自动识别项目的所有主要业务模块（覆盖率 ≥ 90%）
- ✅ 根据模块规模生成 1-4 层深度的文档结构
- ✅ 自动生成文档索引和导航
- ✅ 自动填充 70% 以上的文档内容

### 5.2 用户体验
- ✅ 新用户无需手动配置，直接运行命令即可生成完整文档结构
- ✅ 生成的文档结构清晰，易于导航和理解
- ✅ 文档深度适中，避免信息过载或信息不足
- ✅ 生成的文档内容准确，引用的代码文件路径正确

### 5.3 性能目标
- ✅ 技术栈检测时间 < 5 秒（中型项目）
- ✅ 业务模块识别时间 < 30 秒（大型项目）
- ✅ 文档生成时间 < 90 秒（大型项目，参考 v2.0 规范）
- ✅ 内存占用 < 500 MB（文档生成过程）

### 5.4 质量标准
- ✅ 技术栈检测准确率 ≥ 95%（在已知技术栈上）
- ✅ 业务模块识别准确率 ≥ 90%
- ✅ 生成的文档无格式错误（Markdown 语法正确）
- ✅ 文档间链接有效（无断链）

---

## 6. 假设与依赖

### 6.1 假设
1. 项目遵循标准的 Python/JavaScript 项目结构（如 `src/`、`app/`、`models/` 等目录）
2. 使用常见的依赖管理工具（pyproject.toml、package.json、requirements.txt）
3. 代码遵循基本的命名规范（模块名、类名、函数名有意义）
4. 用户已经使用 `wiki-generator --init` 初始化了配置文件

### 6.2 依赖
1. **依赖 001**：Wiki Generator v2.0 已完成（004-optimize-wiki-docs）
2. **依赖 002**：Python 包提供文件扫描工具（`wiki_generator/utils/file_scanner.py`）
3. **依赖 003**：配置系统支持扩展的检测规则配置（`wiki-config.json` 的 `tech_stack_rules` 字段）
4. **依赖 004**：Claude Code 的 `/wiki-generate` 命令能够执行复杂的 shell 脚本和文件分析

### 6.3 约束
1. **技术栈检测约束**：只能检测导入的依赖，无法检测使用但未导入的库
2. **业务模块识别约束**：对于不规范的目录结构可能识别不准确
3. **内容生成约束**：AI 生成的内容需要人工审核和修正
4. **性能约束**：超大项目（> 1000 文件）可能需要更长处理时间
5. **并发处理约束**：采用全串行处理策略，避免并发导致的资源竞争和内存峰值
6. **实施架构约束**：所有核心逻辑（技术栈检测、模块识别、文档生成）必须在 Claude Code Agent/Skill 中实现，不创建独立的 Python 模块包

---

## 7. 实施建议

### 7.1 实施架构

**核心决策**：采用 Claude Code Agent/Skill 架构，而非独立的 Python 模块包。

**架构说明**：
- **实现位置**：所有核心逻辑在 `.claude/skills/` 或 `.claude/agents/` 目录中实现
- **调用方式**：通过 `/wiki-generate` 命令调用 Agent/Skill
- **技术栈**：Agent/Skill 使用 Shell 脚本 + 内联 Python 片段，无需独立打包
- **优势**：
  - 符合项目定位（Claude Code 工具，非独立 Python 包）
  - 避免过度工程（无需创建 core/、utils/ 等模块）
  - 易于维护（逻辑集中在 Agent/Skill 文件中）
  - 用户可读性高（Shell 脚本比 Python 模块更直观）

**不创建的模块**：
- ❌ `core/detectors/`、`core/extractors/`、`core/generators/`
- ❌ `utils/` 工具模块
- ❌ `tests/unit/` Python 单元测试

**保留的结构**：
- ✅ `.claude/commands/wiki-generate.md`（命令入口）
- ✅ `.claude/skills/doc-generator/` 或 `.claude/agents/doc-generator/`（核心逻辑）
- ✅ `tests/integration/`（集成测试，测试整个 Agent/Skill 工作流）

### 7.2 实施阶段

**阶段 1：技术栈检测增强**（1-2 天）
- 在 Agent/Skill 中扩充技术栈检测规则（从 10+ 扩展到 20+）
- 添加前端框架、CLI 框架、消息队列等检测规则
- 实现多方法组合检测（代码导入 + 文件系统 + 配置文件）
- 测试检测准确率

**阶段 2：业务模块识别**（2-3 天）
- 在 Agent/Skill 中实现目录结构扫描逻辑
- 实现模块规模评估逻辑（只统计源代码文件）
- 实现 Monorepo 结构检测和子项目识别
- 实现模块层级深度决策逻辑
- 测试多个真实项目

**阶段 3：自适应内容生成**（3-5 天）
- 在 Agent/Skill 中实现项目信息提取逻辑（从 README、pyproject.toml、代码文件）
- 实现文档模板变量填充逻辑
- 实现模块化文档内容生成（根据模块规模）
- 实现分层降级策略（README → 配置文件 → Docstring → 注释 → 模板）
- 测试生成内容质量

**阶段 4：索引和导航生成**（1-2 天）
- 在 Agent/Skill 中实现文档索引生成逻辑
- 实现文档间交叉引用链接
- 测试链接有效性

**阶段 5：集成测试和优化**（2-3 天）
- 在多个真实项目上测试端到端流程
- 优化性能（减少生成时间，优化 Shell 脚本）
- 修复边缘情况
- 编写集成测试（不编写单元测试）

**总计**：9-15 天

### 7.3 技术实施要点

**技术栈检测实现**：
```bash
# 扩充 wiki-generate.md 中的检测逻辑
detect_tech_stack() {
    local tech_stack=()

    # 后端框架
    if grep -rq "from fastapi" src/ || grep -rq "import fastapi" src/; then
        tech_stack+=("fastapi")
    fi
    if grep -rq "from flask" src/; then
        tech_stack+=("flask")
    fi

    # CLI 框架
    if grep -rq "import click" src/ || grep -rq "from click" src/; then
        tech_stack+=("click")
    fi

    # 前端框架
    if [ -f "package.json" ] && grep -q '"react"' package.json; then
        tech_stack+=("react")
    fi

    # 消息队列
    if grep -rq "import kafka" src/; then
        tech_stack+=("kafka")
    fi

    echo "${tech_stack[@]}"
}
```

**业务模块识别实现**：
```bash
# 扫描服务层
identify_service_modules() {
    local service_dirs=("src/services" "app/services" "services")
    local modules=()

    for dir in "${service_dirs[@]}"; do
        if [ -d "$dir" ]; then
            for file in "$dir"/*.py; do
                if [ "$(basename "$file")" != "__init__.py" ]; then
                    module_name=$(basename "$file" .py)
                    modules+=("$dir:$module_name")
                fi
            done
        fi
    done

    echo "${modules[@]}"
}

# 评估模块规模
calculate_module_scale() {
    local module_path=$1
    local file_count=$(find "$module_path" -type f -name "*.py" | wc -l)

    if [ "$file_count" -le 4 ]; then
        echo "small"
    elif [ "$file_count" -le 20 ]; then
        echo "medium"
    elif [ "$file_count" -le 50 ]; then
        echo "large"
    else
        echo "xlarge"
    fi
}
```

**自适应内容生成实现**：
```bash
# 从 pyproject.toml 提取项目信息
extract_project_info() {
    local project_name=$(grep "^name = " pyproject.toml | sed 's/name = "\(.*\)"/\1/')
    local description=$(grep "^description = " pyproject.toml | sed 's/description = "\(.*\)"/\1/')
    local version=$(grep "^version = " pyproject.toml | sed 's/version = "\(.*\)"/\1/')

    echo "$project_name|$description|$version"
}

# 从 README 提取核心功能
extract_features() {
    local features=()
    while IFS= read -r line; do
        if [[ "$line" =~ ^-\ .* ]]; then
            features+=("$line")
        fi
    done < README.md

    echo "${features[@]}"
}
```

---

## 8. 风险与缓解

### 8.1 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 技术栈检测不准确 | 生成错误的文档 | 中 | 1. 使用多种检测方法组合（导入 + 文件 + 配置）<br>2. 提供手动覆盖配置 |
| 业务模块识别遗漏 | 缺少重要文档 | 高 | 1. 支持多种目录结构模式<br>2. 提供手动添加模块的配置 |
| 生成内容质量差 | 需要大量手动编辑 | 中 | 1. 使用更好的提示词工程<br>2. 提供内容模板和示例 |
| 性能问题（大项目） | 生成时间过长 | 中 | 1. 采用串行处理策略，避免并发开销<br>2. 缓存检测结果<br>3. 优化文件扫描算法 |

### 8.2 用户体验风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 生成的文档结构不符合用户预期 | 用户满意度低 | 中 | 1. 提供配置选项调整层级深度<br>2. 在生成前预览文档大纲 |
| 过度生成文档（太多子文档） | 文档难以维护 | 低 | 1. 设置合理的层级深度阈值<br>2. 提供配置选项控制生成粒度 |
| 内容过于通用（缺乏项目特性） | 文档实用性差 | 中 | 1. 深入分析代码提取项目特定信息<br>2. 提供手动编辑指南 |

---

## 9. 后续增强

### 9.1 短期增强（3-6 个月）
- **交互式文档大纲预览**：生成前让用户确认和调整文档大纲
- **自定义检测规则**：允许用户添加自定义技术栈检测规则
- **文档模板自定义**：允许用户为特定模块类型提供自定义模板
- **增量更新优化**：只更新变更的模块（而非完全覆盖）

### 9.2 中长期增强（6-12 个月）
- **机器学习辅助**：使用 ML 模型预测需要哪些文档
- **文档质量评分**：自动评估生成文档的质量并给出改进建议
- **多语言支持增强**：自动翻译文档到多种语言
- **可视化配置工具**：提供 Web UI 配置文档生成规则

---

## 10. 验收标准总结

| 类别 | 指标 | 目标值 | 验证方法 |
|------|------|--------|----------|
| **功能完整性** | 技术栈检测数量 | ≥ 20 种 | 单元测试 |
| | 业务模块识别覆盖率 | ≥ 90% | 真实项目测试 |
| | 文档层级深度支持 | 1-4 层 | 功能测试 |
| | 自动内容填充率 | ≥ 70% | 内容分析 |
| **用户体验** | 新用户零配置可用性 | 100% | 用户测试 |
| | 文档结构清晰度 | ≥ 4/5 分 | 用户调研 |
| | 内容准确性 | ≥ 95% | 人工审核 |
| **性能** | 技术栈检测时间 | < 5 秒 | 性能测试 |
| | 业务模块识别时间 | < 30 秒 | 性能测试 |
| | 文档生成时间 | < 90 秒 | 性能测试 |
| **质量** | 技术栈检测准确率 | ≥ 95% | 准确率测试 |
| | 模块识别准确率 | ≥ 90% | 准确率测试 |
| | Markdown 格式正确率 | 100% | 静态检查 |
| | 文档链接有效率 | 100% | 链接检查 |

---

**版本**: 1.0.0
**最后更新**: 2026-01-04
**状态**: 待评审
