# 功能规范：优化 Wiki 文档结构和模板

**版本**: 1.0.0
**创建日期**: 2025-01-04
**状态**: 草稿

## 1. 功能概述

### 1.1 简短名称
`optimize-wiki-docs`

### 1.2 功能描述
基于参考项目 `/home/yewenbin/work/tools/dingtalk-notable-connect/.qoder/repowiki` 生成的文档结构和格式，优化 `wiki-generator` 命令及其模板，使其生成的 Wiki 文档具有：
- 分层的目录结构（按功能模块组织）
- 统一的文档格式（包含引用、目录、章节等）
- 完整的文档类型（快速开始、项目概述、数据模型、操作指南等）
- 文件间的交叉引用链接
- 中文本地化支持

### 1.3 业务价值
- **提升文档可读性**：清晰的分层目录结构便于用户快速定位信息
- **标准化文档格式**：统一的模板确保所有项目文档风格一致
- **改善导航体验**：目录索引和交叉引用帮助用户理解文档关系
- **支持中文项目**：完整的中文模板支持国内项目使用
- **减少维护成本**：参考成熟项目的文档结构，避免重复设计

---

## Clarifications

### Session 2025-01-04

- Q: 文档语言生成策略 - 同时生成中英文还是根据配置选择？ → A: 配置驱动（默认只生成配置中指定的一种语言，避免冗余）
- Q: 已存在文档的处理策略 - 用户手动修改后如何更新？ → B: 完全覆盖策略（直接覆盖整个文档，适用于完全由 AI 生成的场景）
- Q: 条件文档的生成规则 - 如何判断哪些条件文档需要生成？ → B: 自动检测（AI 分析代码库自动判断，如检测到 SQLAlchemy 则生成数据模型文档）
- Q: 项目规模定义和性能目标 - 如何定义中小型项目及对应的性能目标？ → A: 明确规模分级（小型 < 100 文件 < 15 秒；中型 100-500 文件 < 30 秒；大型 > 500 文件 < 90 秒）
- Q: 向后兼容性级别 - 新旧结构之间如何处理兼容性？ → C: 破坏性变更（不保证向后兼容，提供清晰的迁移指南，用户必须手动更新配置和模板）

---

## 2. 参考文档分析

### 2.1 参考项目文档结构

基于 `/home/yewenbin/work/tools/dingtalk-notable-connect/.qoder/repowiki/zh/content/` 的分析：

**一级目录**（按功能模块组织）：
```
zh/content/
├── 快速开始.md              # 入门指南
├── 项目概述.md              # 项目介绍和架构
├── 技术栈与依赖.md          # 技术选型说明
├── 数据模型/               # 数据结构文档
├── 数据库连接管理/          # 数据库相关功能
├── 数据导入执行/           # 核心业务流程
├── 导入历史与配置管理/      # 管理功能
├── 数据查看器/             # 用户界面功能
├── 系统架构设计/           # 架构文档
├── 开发指南/               # 开发相关
├── 部署指南/               # 部署相关
├── 测试策略/               # 测试相关
├── 故障排除/               # 问题解决
├── 安全考虑/               # 安全相关
├── 操作审计日志/           # 审计功能
└── 字段映射配置/           # 配置说明
```

**文档格式特点**：
1. **统一的页头结构**：
   ```markdown
   # 文档标题

   <cite>
   **本文档中引用的文件**
   - [README.md](file://README.md)
   - [src/main.py](file://src/main.py)
   ...
   </cite>

   ## 目录
   1. [章节1](#章节1)
   2. [章节2](#章节2)
   ...
   ```

2. **Section sources 引用**：每个章节末尾标注来源文件
   ```markdown
   **Section sources**
   - [README.md](file://README.md#L1-L50)
   - [src/main.py](file://src/main.py#L10-L30)
   ```

3. **清晰的章节层次**：使用多级标题（##、###、####）

4. **代码示例和配置**：大量使用代码块展示示例

### 2.2 当前 Wiki Generator 模板分析

**当前模板**（`wiki_generator/.claude/templates/`）：
```
templates/
├── overview.md.template      # 项目概览
├── module.md.template        # 模块文档
├── api.md.template          # API 文档
├── architecture.md.template  # 架构文档
├── development.md.template   # 开发指南
└── index.md.template        # 索引
```

**当前模板的问题**：
1. ❌ 目录结构扁平，所有文档放在 `docs/` 根目录
2. ❌ 缺少分层组织（没有按功能模块分类）
3. ❌ 缺少统一的文档格式（引用、目录、Section sources）
4. ❌ 缺少中文模板支持
5. ❌ 文档类型不完整（缺少快速开始、故障排除等）

---

## 3. 用户场景与测试

### 3.1 主要用户角色

**角色 1：项目负责人**
- **需求**：生成结构化的项目文档，便于团队协作
- **痛点**：当前生成的文档结构混乱，难以导航
- **目标**：快速获得符合行业标准的文档结构

**角色 2：新加入开发者**
- **需求**：快速找到所需信息（快速开始、故障排除等）
- **痛点**：文档分散，缺少快速入门指南
- **目标**：通过"快速开始"在 5 分钟内了解项目

**角色 3：技术文档维护者**
- **需求**：维护统一的文档格式和风格
- **痛点**：手动调整格式耗时，容易不一致
- **目标**：自动生成符合规范的文档

### 3.2 核心用户流程

#### 流程 1：生成完整文档（新项目）

**场景**：开发者创建新项目，需要生成完整的结构化文档

**步骤**：
1. 开发者在项目根目录执行 `wiki-generator --full`
2. 系统自动检测项目类型（Web/CLI/Lib 等）和技术栈
3. AI 分析代码库，判断需要生成哪些条件文档（如检测到数据库相关代码则生成"数据模型"文档）
4. 生成分层目录结构（根据配置的语言）：
   ```
   # 单语言示例（language: "zh"）
   docs/
   └── zh/
       └── content/
           ├── 00-快速开始.md
           ├── 01-项目概述.md
           ...
   ```
4. 每个文档包含：
   - 引用文件列表（<cite>）
   - 目录索引
   - Section sources

**预期结果**：
- ✅ 文档目录结构清晰，符合参考项目标准
- ✅ 每个文档格式统一
- ✅ 包含所有必要文档类型
- ✅ 支持中文和英文（根据配置）

#### 流程 2：增量更新（保持结构）

**场景**：代码变更后更新对应文档

**步骤**：
1. 开发者修改代码（如 `src/auth/login.py`）
2. 执行 `wiki-generator --update`
3. 系统识别变更的模块
4. 更新对应文档（如 `docs/zh/content/05-核心功能/认证模块.md`）
5. 保持文档结构和格式不变

**文档覆盖策略**：
- **完全覆盖**：直接覆盖整个文档，不保留手动修改
- **适用场景**：文档完全由 AI 生成和管理的场景
- **用户责任**：如需保留手动编辑，应通过其他方式维护（如分支或复制）

**预期结果**：
- ✅ 只更新受影响的文档
- ✅ 保持文档目录结构
- ✅ 保持文档格式统一
- ✅ 文档内容完全由最新代码生成

---

## 4. 功能需求

### 4.1 目录结构优化

**FR-01**: 生成的文档必须采用分层目录结构

**需求详情**：
- 一级目录按语言分类：`docs/zh/`, `docs/en/`
- 二级目录统一使用 `content/`
- 三级目录按功能模块分类：
  - `00-序号-文档名.md`（顶级文档）
  - `功能模块名称/`（模块目录）
  - `功能模块名称/子模块.md`（模块文档）

**验收标准**：
- [ ] 生成的目录结构与参考项目一致
- [ ] 顶级文档使用数字前缀排序（00-99）
- [ ] 模块目录名称清晰反映功能

**FR-02**: 支持自定义目录结构配置

**需求详情**：
- 通过配置文件（`.claude/wiki-config.json`）指定目录结构
- 支持预设模板（参考项目结构、简化结构等）
- 支持自定义模块分组
- **条件文档生成**：AI 自动分析代码库判断是否生成条件文档（如数据模型、数据库相关文档）

**验收标准**：
- [ ] 可以选择"参考项目"模板
- [ ] 可以自定义模块分组规则
- [ ] 配置文件格式符合 JSON Schema
- [ ] AI 能准确检测项目特征并生成相应的条件文档
- [ ] 用户可以覆盖自动检测结果（通过配置明确指定）

### 4.2 文档模板优化

**FR-03**: 所有模板必须包含统一的页头结构

**需求详情**：
每个文档必须包含：
1. 文档标题（H1）
2. 引用文件列表（<cite> block）
3. 目录索引（自动生成）
4. 章节内容
5. Section sources（每个章节末尾）

**模板结构**：
```markdown
# {文档标题}

<cite>
**本文档中引用的文件**
- [{文件名}](file://{相对路径})
- ...
</cite>

## 目录
1. [{章节1}](#{章节1锚点})
2. [{章节2}](#{章节2锚点})
...

## {章节1标题}
{章节内容}

**Section sources**
- [{文件名}](file://{相对路径}#L{行号}-L{行号})
...
```

**验收标准**：
- [ ] 所有模板包含上述结构
- [ ] 引用文件列表自动从代码分析中提取
- [ ] 目录索引自动根据标题生成
- [ ] Section sources 准确记录来源

**FR-04**: 提供完整的文档类型模板

**需求详情**：
必须包含以下模板（基于参考项目）：
1. `quickstart.md.template` - 快速开始
2. `overview.md.template` - 项目概述
3. `techstack.md.template` - 技术栈与依赖
4. `architecture.md.template` - 系统架构
5. `datamodel.md.template` - 数据模型
6. `corefeatures.md.template` - 核心功能
7. `development.md.template` - 开发指南
8. `deployment.md.template` - 部署指南
9. `testing.md.template` - 测试策略
10. `troubleshooting.md.template` - 故障排除
11. `security.md.template` - 安全考虑

**验收标准**：
- [ ] 所有模板文件存在
- [ ] 每个模板包含参考项目的关键章节
- [ ] 模板支持变量替换（项目名、版本号等）

**FR-05**: 支持中文和英文模板

**需求详情**：
- 提供两套模板：`templates/zh/` 和 `templates/en/`
- **默认行为**：根据配置文件中的 `language` 字段只生成一种语言的文档（避免冗余）
- 配置选项：`"language": "zh"`（中文）、`"language": "en"`（英文）、`"language": "both"`（双语）
- 中文模板使用中文标题和示例
- 英文模板使用英文标题和示例

**验收标准**：
- [ ] `templates/zh/` 包含所有中文模板
- [ ] `templates/en/` 包含所有英文模板
- [ ] 配置文件可以指定语言：`"language": "zh" | "en" | "both"`
- [ ] 默认只生成配置中指定的一种语言文档
- [ ] 当 `language: "both"` 时，同时生成 `docs/zh/` 和 `docs/en/` 两个目录

### 4.3 交叉引用支持

**FR-06**: 自动生成文档间的交叉引用链接

**需求详情**：
- 识别文档中提到的其他模块、API、配置文件
- 自动插入相对路径链接
- 支持三种链接类型：
  - 文档链接：`[文档名](../path/to/doc.md)`
  - 代码链接：`[文件名](file://../../src/file.py#L10)`
  - 锚点链接：`[章节名](#章节锚点)`

**验收标准**：
- [ ] 识别文档中的模块引用（如"参见认证模块"）
- [ ] 自动生成正确的相对路径
- [ ] 链接在生成的文档中有效
- [ ] 支持手动标记链接（使用特殊语法）

### 4.4 配置和扩展

**FR-07**: 支持文档结构配置

**需求详情**：
通过 `.claude/wiki-config.json` 配置：
```json
{
  "output_dir": "docs",
  "language": "zh",
  "structure_template": "reference",  // "reference" | "simple" | "custom"
  "custom_structure": {
    "sections": [
      {"name": "快速开始", "template": "quickstart", "order": 0},
      {"name": "核心功能", "template": "corefeatures", "order": 5, "subsections": [...]}
    ]
  },
  "include_sources": true,
  "generate_toc": true
}
```

**验收标准**：
- [ ] 配置文件格式符合规范
- [ ] 支持 `structure_template` 选择预设
- [ ] 支持自定义结构配置
- [ ] 配置验证通过（JSON Schema）

**FR-08**: 迁移支持

**需求详情**：
- **破坏性变更**：不保证向后兼容，新旧结构有本质差异
- **迁移指南**：提供详细的迁移步骤文档
- **配置验证**：检测旧配置格式并提供明确的错误消息和迁移指引
- **迁移工具**：提供辅助工具帮助用户转换配置（但需要用户手动执行）

**验收标准**：
- [ ] 提供详细的迁移指南文档
- [ ] 检测到旧配置时显示清晰的错误消息和迁移步骤
- [ ] 提供配置转换脚本或工具
- [ ] 文档清楚说明新旧结构的差异和迁移必要性

---

## 5. 成功标准

### 5.1 定量指标

| 指标 | 目标值 | 测量方式 |
|------|--------|----------|
| 文档结构符合度 | 100% | 与参考项目目录结构对比 |
| 模板完整度 | 100% | 11 个必需模板全部存在 |
| 格式统一性 | 100% | 所有文档包含 <cite>、目录、Section sources |
| 生成速度（小型项目） | < 15 秒 | < 100 个文件，< 10K 行代码的完整文档生成时间 |
| 生成速度（中型项目） | < 30 秒 | 100-500 个文件，10K-50K 行代码的完整文档生成时间 |
| 生成速度（大型项目） | < 90 秒 | > 500 个文件，> 50K 行代码的完整文档生成时间 |
| 链接准确率 | ≥ 95% | 交叉引用链接有效比例 |

### 5.2 定性指标

| 指标 | 验证方式 |
|------|----------|
| 文档可读性 | 用户测试：5 分钟内找到所需信息 |
| 导航体验 | 用户测试：目录和链接帮助快速定位 |
| 格式一致性 | 自动检查：所有文档格式符合规范 |
| 易用性 | 开发者反馈：配置简单，易于自定义 |

### 5.3 用户验收标准

**UAT-01**: 新项目可以在 5 分钟内生成完整文档
- 步骤：
  1. 创建新项目
  2. 运行 `wiki-generator --full`
  3. 检查生成的文档
- 预期：文档结构完整，符合参考项目标准

**UAT-02**: 开发者可以快速找到文档
- 步骤：
  1. 打开生成的文档
  2. 查找"快速开始"
  3. 查找"故障排除"
- 预期：通过目录或索引快速定位

**UAT-03**: 文档格式统一
- 步骤：
  1. 打开任意 5 个生成的文档
  2. 检查页头结构
- 预期：所有文档包含 <cite>、目录、Section sources

---

## 6. 实施计划

### 6.1 阶段划分

**Phase 1: 模板开发**（5 天）
- 创建中文模板（11 个）
- 创建英文模板（11 个）
- 添加引用、目录、Section sources 支持

**Phase 2: 目录结构逻辑**（3 天）
- 实现分层目录生成
- 实现数字前缀排序
- 支持自定义结构配置

**Phase 3: 交叉引用**（2 天）
- 实现链接识别和生成
- 支持三种链接类型
- 链接验证

**Phase 4: 配置和兼容**（2 天）
- 实现配置文件解析
- 添加迁移工具
- 向后兼容性测试

**Phase 5: 测试和优化**（3 天）
- 单元测试
- 集成测试
- 用户验收测试

**总计**: 15 个工作日

### 6.2 依赖关系

```
Phase 1 (模板开发)
    ↓
Phase 2 (目录结构) ← Phase 3 (交叉引用)
    ↓                    ↓
Phase 4 (配置和兼容)
    ↓
Phase 5 (测试和优化)
```

### 6.3 关键里程碑

- **M1** (Day 5): 所有模板创建完成
- **M2** (Day 8): 目录结构生成工作
- **M3** (Day 10): 交叉引用功能完成
- **M4** (Day 12): 配置和迁移完成
- **M5** (Day 15): 所有测试通过，发布

---

## 7. 风险与假设

### 7.1 假设

**A-01**: 用户熟悉 Markdown 文档编写
**A-02**: 项目可以使用 Git 进行版本控制
**A-03**: 用户能够配置简单的 JSON 文件
**A-04**: 参考项目的文档结构适用于大多数项目

### 7.2 风险

**R-01**: 参考项目结构可能不适合所有类型的项目
- **缓解措施**: 提供多种结构模板（参考、简化、自定义）

**R-02**: Section sources 可能增加生成复杂度
- **缓解措施**: 作为可选项，默认关闭

**R-03**: 交叉引用链接可能失效
- **缓解措施**: 提供链接验证工具

**R-04**: 中文模板翻译质量可能不够专业
- **缓解措施**: 使用技术写作标准，支持人工校对

**R-05**: 破坏性变更可能导致现有用户无法升级
- **缓解措施**: 提供清晰的迁移指南和工具，在发布前广泛通知

---

## 8. 附录

### 8.1 参考项目文档清单

从 `/home/yewenbin/work/tools/dingtalk-notable-connect/.qoder/repowiki/zh/content/` 提取的文档类型：

| 序号 | 文档名称 | 类型 | 是否必需 |
|------|----------|------|----------|
| 00 | 快速开始 | 入门 | ✅ 是 |
| 01 | 项目概述 | 概览 | ✅ 是 |
| 02 | 技术栈与依赖 | 技术说明 | ✅ 是 |
| 03 | 系统架构设计 | 架构 | ✅ 是 |
| 04 | 数据模型 | 数据 | ⚠️ 条件 |
| 05 | 数据库连接管理 | 功能 | ⚠️ 条件 |
| 06 | 数据导入执行 | 功能 | ⚠️ 条件 |
| 07 | 导入历史与配置管理 | 功能 | ⚠️ 条件 |
| 08 | 数据查看器 | 功能 | ⚠️ 条件 |
| 09 | 字段映射配置 | 配置 | ⚠️ 条件 |
| 10 | 开发指南 | 开发 | ✅ 是 |
| 11 | 部署指南 | 部署 | ✅ 是 |
| 12 | 测试策略 | 测试 | ✅ 是 |
| 13 | 故障排除 | 故障排除 | ✅ 是 |
| 14 | 安全考虑 | 安全 | ✅ 是 |
| 15 | 操作审计日志 | 功能 | ⚠️ 条件 |

**标注**：
- ✅ 是：所有项目必需
- ⚠️ 条件：根据项目类型包含（如数据库项目包含"数据模型"）

### 8.2 模板变量列表

每个模板支持的变量：

| 变量名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `{project_name}` | string | 项目名称 | "dingtalk-notable-connect" |
| `{version}` | string | 版本号 | "1.0.0" |
| `{description}` | string | 项目描述 | "钉钉数据导入工具" |
| `{author}` | string | 作者 | "Team Name" |
| `{language}` | string | 语言 | "zh" / "en" |
| `{generated_date}` | date | 生成日期 | "2025-01-04" |
| `{cite_files}` | list | 引用文件列表 | ["README.md", "src/main.py"] |
| `{sections}` | list | 章节列表 | [{"title": "简介", "content": "..."}] |
| `{section_sources}` | object | 章节来源 | {"简介": ["README.md#L1-L10"]} |

### 8.3 配置文件示例

完整的 `.claude/wiki-config.json` 示例：

```json
{
  "$schema": "./schema/wiki-config-schema.json",
  "output_dir": "docs",
  "language": "zh",
  "structure_template": "reference",
  "include_sources": true,
  "generate_toc": true,
  "sections": {
    "required": [
      "quickstart",
      "overview",
      "techstack",
      "architecture",
      "development",
      "deployment",
      "testing",
      "troubleshooting",
      "security"
    ],
    "optional": [
      "datamodel",
      "corefeatures"
    ]
  },
  "formatting": {
    "code_block_syntax": true,
    "line_numbers": true,
    "section_sources": true
  },
  "links": {
    "auto_generate": true,
    "validate": true
  }
}
```

---

**规范版本**: 1.0.0
**创建日期**: 2025-01-04
**最后更新**: 2025-01-04
**状态**: 草稿 - 待审查
