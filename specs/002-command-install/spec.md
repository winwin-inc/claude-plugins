# 功能规范：Claude Code 命令安装器

**版本**: 1.0.0
**创建日期**: 2025-01-03
**状态**: 草稿

## 1. 功能概述

### 1.1 简短名称
`wiki-generator`

### 1.2 功能描述
创建一个名为 **wiki-generator** 的独立 Python CLI 工具，用于自动安装 Claude Code 自定义命令及其相关模板文件到用户的项目中。该工具通过 `uvx wiki-generator` 命令调用，可以将命令文件（如 `.claude/commands/wiki-generate.md`）和模板文件（`.claude/templates/`）安装到当前命令运行目录下。

### 1.3 业务价值
- **简化命令安装流程**：用户无需手动复制文件，一条命令即可完成安装
- **提高开发效率**：快速获取和使用社区贡献的命令
- **标准化命令管理**：统一的安装、更新、卸载流程
- **降低学习成本**：新用户可以轻松发现和安装有用的命令
- **促进命令生态**：方便命令开发者分发和维护命令

---

## Clarifications

### Session 2025-01-03

- Q: 实现技术栈选择 → A: Python 命令行工具（跨平台、功能强大、易维护）
- Q: 项目依赖管理工具 → A: 使用 uv（快速、现代、兼容 pip）
- Q: 是否需要 Claude Code 命令集成 → A: 不需要 command-install.md，直接作为独立 Python CLI 工具使用
- Q: 项目命名和调用方式 → A: **项目名称为 `wiki-generator`，使用 `uvx wiki-generator` 命令调用**
- Q: 默认调用行为 → A: **`uvx wiki-generator` 无参数执行，将本项目 `.claude/` 目录复制到运行命令的当前目录**

**影响**:
- 实现方式：使用 Python 3.8+ 开发独立 CLI 工具
- 依赖管理：通过 `uv` 管理项目依赖（替代 requirements.txt/pip）
- 集成方式：**使用 `uvx wiki-generator` 命令调用**（uv 会自动处理依赖和执行）
- **核心功能**：将 wiki-generator 项目**自身**的 `.claude/` 目录内容复制到用户项目
- **源位置**：从 wiki-generator 包内的 `.claude/` 目录读取（而非外部 Git 仓库）
- **目标位置**：复制到**运行命令的当前工作目录**的 `.claude/` 目录
- **默认行为**：**无参数调用**即执行复制安装操作
- 跨平台支持：确保在 Windows、macOS、Linux 上运行一致
- 分发方式：通过 PyPI 分发，使用 `uvx` 或 `pipx` 运行
- **不创建** `.claude/commands/wiki-generator.md` 文件
- **项目名称**: `wiki-generator`（而非 command-install）

**调用示例**:
```bash
# 使用 uvx 运行（推荐）
uvx wiki-generator

# 或者在用户项目目录中执行
cd /path/to/user/project
uvx wiki-generator
# 将 .claude/ 目录复制到 /path/to/user/project/
```

---

## 2. 用户场景与测试

### 2.1 主要用户角色

**角色 1：Claude Code 用户**
- **需求**：快速安装其他开发者创建的自定义命令
- **痛点**：手动从 GitHub 复制文件和配置过程繁琐
- **目标**：通过简单命令安装和配置命令

**角色 2：命令开发者**
- **需求**：分发和维护自己的自定义命令
- **痛点**：用户难以发现和使用命令，安装指导复杂
- **目标**：提供简单的安装方式让用户获取命令

**角色 3：项目维护者**
- **需求**：为团队项目安装标准命令集
- **痛点**：需要为每个开发者手动配置命令
- **目标**：通过配置文件批量安装团队命令

### 2.2 核心用户流程

#### 流程 1：从仓库安装命令

**场景**：开发者发现了一个有用的自定义命令，想要安装到自己的项目中

**步骤**：
1. 开发者在项目根目录执行 `uvx wiki-generator install <repo-url>`
2. 命令自动克隆或下载仓库内容
3. 提取命令文件到 `.claude/commands/` 目录
4. 提取相关模板文件到 `.claude/templates/` 目录
5. 提取配置文件（如果存在）
6. 验证安装成功
7. 显示安装摘要

**预期结果**：
- 命令文件正确安装在 `.claude/commands/` 目录
- 模板文件正确安装在 `.claude/templates/` 目录
- 命令立即可用，无需手动配置
- 显示安装成功的确认消息

#### 流程 2：列出已安装命令

**场景**：开发者想要查看当前项目中已安装哪些自定义命令

**步骤**：
1. 开发者执行 `wiki-generator list`
2. 命令扫描 `.claude/commands/` 目录
3. 读取每个命令文件的 frontmatter 元数据
4. 显示命令列表，包括名称、描述、版本

**预期结果**：
- 显示已安装命令的列表
- 每个命令显示名称、描述和版本信息
- 格式化输出，易于阅读

#### 流程 3：更新已安装命令

**场景**：命令发布新版本，开发者想要更新已安装的命令

**步骤**：
1. 开发者执行 `wiki-generator update <command-name>`
2. 命令检查命令来源信息
3. 从原始来源获取最新版本
4. 备份当前版本
5. 替换命令文件和相关资源
6. 验证更新成功
7. 显示更新摘要

**预期结果**：
- 命令更新到最新版本
- 保留用户配置（如果有）
- 显示变更日志（如果可用）

#### 流程 4：卸载命令

**场景**：开发者不再需要某个命令，想要从项目中移除

**步骤**：
1. 开发者执行 `wiki-generator uninstall <command-name>`
2. 命令显示要删除的文件列表
3. 请求用户确认
4. 删除命令文件和相关资源
5. 显示卸载成功消息

**预期结果**：
- 命令文件和相关资源被删除
- 清理孤立文件
- 显示卸载成功的确认消息

#### 流程 5：批量安装命令

**场景**：新项目初始化，需要安装一套标准命令

**步骤**：
1. 开发者在配置文件中定义需要安装的命令列表
2. 执行 `command-install install --batch`
3. 命令读取配置文件
4. 依次安装所有命令
5. 处理依赖关系
6. 显示安装摘要

**预期结果**：
- 所有列出的命令被安装
- 依赖关系正确处理
- 显示整体安装摘要

---

## 3. 功能需求

### 3.1 核心命令

#### 命令：`wiki-generator <action> [options]` - Wiki 生成器安装工具

**描述**：统一的命令安装和管理工具（独立 Python CLI 工具）

**命令格式**：
```bash
wiki-generator install <source> [command-name]
wiki-generator list
wiki-generator update <command-name>
wiki-generator uninstall <command-name>
wiki-generator info <command-name>
```

**调用方式**：
```bash
# 方式 1：使用 uvx 运行（推荐）
uvx wiki-generator install <source>

# 方式 2：安装后直接调用
wiki-generator install <source>
```

---

#### 动作 1：`install` - 安装命令

**描述**：从指定来源安装命令及相关资源

**参数**：
- `source`: 命令来源（Git 仓库 URL、本地路径、预设名称）
- `command-name`: 可选，指定要安装的命令名称

**功能**：
1. **来源解析**：
   - 支持 Git 仓库 URL（https://github.com/user/repo）
   - 支持本地文件路径（./commands/my-command.md）
   - 支持预设命令名称（如：wiki-generator）

2. **资源提取**：
   - 扫描源位置，识别命令文件（.md 文件）
   - 识别相关模板文件
   - 识别配置文件
   - 识别依赖关系

3. **安装流程**：
   - 创建必要的目录结构（如果不存在）
   - 复制命令文件到 `.claude/commands/`
   - 复制模板文件到 `.claude/templates/`
   - 处理文件冲突（重命名、覆盖、跳过）
   - 记录安装来源信息（用于后续更新）

4. **验证**：
   - 验证命令文件格式正确
   - 验证 frontmatter 元数据完整
   - 验证模板文件语法正确

5. **安装后操作**：
   - 显示安装摘要
   - 提供使用示例
   - 提示相关命令（如果存在）

**输出**：
- 安装的命令列表
- 文件位置
- 使用说明

**验收标准**：
- 命令正确安装到指定位置
- 相关文件正确复制
- 验证检查通过
- 用户收到清晰的反馈

**性能**：< 30 秒（标准命令安装）

---

#### 动作 2：`list` - 列出已安装命令

**描述**：显示当前项目中所有已安装的自定义命令

**功能**：
1. **扫描目录**：
   - 扫描 `.claude/commands/` 目录
   - 识别所有 .md 命令文件

2. **提取元数据**：
   - 读取每个命令文件的 frontmatter
   - 提取描述、版本、作者等信息

3. **格式化显示**：
   - 表格形式展示命令列表
   - 包括命令名称、描述、版本、安装日期

4. **统计信息**：
   - 总命令数量
   - 存储空间占用
   - 依赖关系摘要

**输出**：
```
已安装的命令：

| 命令名称 | 描述 | 版本 | 安装日期 |
|---------|------|------|---------|
| wiki.generate | Wiki 文档生成器 | 1.0.0 | 2025-01-03 |
| code.review | 代码审查助手 | 2.1.0 | 2025-01-02 |

总计：2 个命令，占用空间：45 KB
```

**验收标准**：
- 显示所有已安装命令
- 信息准确完整
- 格式清晰易读

**性能**：< 5 秒

---

#### 动作 3：`update` - 更新命令

**描述**：从原始来源更新命令到最新版本

**功能**：
1. **检查更新**：
   - 读取命令的安装来源信息
   - 连接到原始来源
   - 检查是否有新版本

2. **备份当前版本**：
   - 创建当前命令文件的备份
   - 记录当前配置

3. **执行更新**：
   - 下载最新版本的命令文件
   - 更新模板文件
   - 保留用户配置（如果可能）

4. **验证更新**：
   - 验证新版本格式正确
   - 测试基本功能

5. **更新摘要**：
   - 显示变更内容
   - 显示新版本号
   - 提供回滚选项

**输出**：
- 更新进度信息
- 变更摘要
- 版本信息

**验收标准**：
- 命令成功更新
- 用户配置得到保留
- 变更信息清晰

**性能**：< 30 秒

---

#### 动作 4：`uninstall` - 卸载命令

**描述**：从项目中移除命令及相关资源

**功能**：
1. **识别资源**：
   - 定位命令文件
   - 识别相关模板文件
   - 识别配置文件

2. **确认操作**：
   - 显示将要删除的文件列表
   - 请求用户确认

3. **执行卸载**：
   - 删除命令文件
   - 删除相关模板文件
   - 清理孤立文件

4. **清理**：
   - 删除安装记录
   - 清理空目录

**输出**：
- 删除文件列表
- 确认消息
- 清理摘要

**验收标准**：
- 命令及相关资源被完全删除
- 用户得到确认反馈
- 无孤立文件残留

---

#### 动作 5：`info` - 显示命令详细信息

**描述**：显示指定命令的详细信息和资源清单

**功能**：
1. **基本信息**：
   - 命令名称和版本
   - 作者和描述
   - 安装来源

2. **资源清单**：
   - 列出所有相关文件
   - 显示文件路径和大小

3. **依赖关系**：
   - 列出依赖的其他命令
   - 列出依赖的模板

4. **使用统计**：
   - 安装日期
   - 最后更新日期
   - 使用频率（如果可追踪）

**输出**：
```
命令：wiki.generate
版本：1.0.0
作者：Claude Plugins Team
描述：Wiki 文档生成器

资源文件：
- .claude/commands/wiki-generate.md
- .claude/templates/wiki-config.json.template
- .claude/templates/overview.md.template
...

安装来源：https://github.com/user/repo
安装日期：2025-01-03
```

**验收标准**：
- 信息准确完整
- 资源清单详细
- 格式清晰

**性能**：< 5 秒

---

### 3.2 配置管理

#### 配置文件：`.claude/command-install.json`

**描述**：存储命令安装管理器的配置和命令来源信息

**配置项**：
```json
{
  "installed_commands": {
    "wiki-generate": {
      "name": "wiki-generate",
      "version": "1.0.0",
      "source": "https://github.com/user/repo",
      "source_type": "git",
      "installed_at": "2025-01-03T08:00:00Z",
      "files": [
        ".claude/commands/wiki-generate.md",
        ".claude/templates/wiki-config.json.template"
      ],
      "metadata": {
        "author": "Claude Plugins Team",
        "description": "Wiki 文档生成器"
      }
    }
  },
  "install_sources": {
    "presets": {
      "wiki-generator": "https://github.com/user/wiki-generator-repo"
    }
  },
  "settings": {
    "auto_update": false,
    "backup_before_update": true,
    "keep_backup_count": 3
  }
}
```

---

### 3.3 非功能需求

#### 性能需求
- 命令安装：< 30 秒
- 列表显示：< 5 秒
- 命令更新：< 30 秒
- 命令卸载：< 10 秒
- 信息显示：< 5 秒

#### 可靠性需求
- 安装成功率 ≥ 99%
- 更新成功率 ≥ 95%
- 备份创建成功率 100%
- 文件完整性验证通过率 100%

#### 兼容性需求
- 支持 Linux、macOS、Windows
- 支持 Git、HTTPS、本地文件系统
- 支持各种命令文件格式

#### 安全性需求
- 验证命令来源可信度
- 检查文件安全性（不包含恶意代码）
- 不执行未验证的脚本
- 保护用户配置文件

---

### 3.4 错误处理

#### 常见错误场景

**错误 1：命令已存在**
```bash
/command.install install my-command
# 错误：命令 my-command 已存在
# 建议：使用 --force 覆盖，或先卸载现有版本
```

**错误 2：来源无法访问**
```bash
/command.install install https://invalid-url
# 错误：无法访问命令来源
# 建议：检查 URL 是否正确，或使用本地文件
```

**错误 3：命令文件格式错误**
```bash
# 错误：命令文件格式不符合规范
# 建议：联系命令作者修复格式问题
```

**错误 4：权限不足**
```bash
# 错误：没有写入 .claude/ 目录的权限
# 建议：检查目录权限或使用 sudo
```

---

## 4. 成功标准

### 4.1 可量化指标

| 指标 | 目标值 | 测量方式 |
|------|--------|----------|
| 命令安装成功率 | ≥ 99% | 安装 100 个命令，成功 99 个 |
| 安装时间 | < 30 秒 | 测量标准命令安装耗时 |
| 更新成功率 | ≥ 95% | 更新 100 个命令，成功 95 个 |
| 用户满意度 | ≥ 4.0/5.0 | 用户反馈调研 |

### 4.2 质量标准

**安装完整性**：
- 所有必需文件正确安装
- 依赖关系正确处理
- 配置文件正确生成

**信息准确性**：
- 命令列表显示准确
- 版本信息正确
- 资源清单完整

**用户体验**：
- 错误消息友好具体
- 进度反馈及时
- 操作确认清晰

### 4.3 用户体验标准

**易用性**：
- 命令参数直观
- 安装流程简单
- 文档清晰完整

**学习曲线**：
- 5 分钟内完成首次安装
- 命令功能自解释
- 帮助信息详细

**效率提升**：
- 减少 90% 的手动配置时间
- 减少 80% 的错误发生率

---

## 5. 关键实体

### 5.1 命令元数据

**属性**：
- 命令名称
- 命令版本
- 作者信息
- 命令描述
- 安装来源
- 安装日期
- 文件列表
- 依赖关系

**关系**：
- 命令 ← 包含 → 文件
- 命令 ← 依赖 → 其他命令
- 命令 ← 使用 → 模板

### 5.2 安装来源

**属性**：
- 来源类型（Git/本地/预设）
- 来源 URL
- 访问凭证（如果需要）
- 最后检查时间
- 可用版本列表

---

## 6. 假设与约束

### 6.1 假设

1. **用户环境假设**：
   - 用户已安装 Claude Code CLI
   - 用户有写入 `.claude/` 目录的权限
   - 用户有基本的 Git 操作能力

2. **命令格式假设**：
   - 命令文件使用 Markdown 格式
   - 命令文件包含 frontmatter 元数据
   - 命令文件命名遵循 `command-name.md` 格式

3. **来源可靠性假设**：
   - Git 仓库公开可访问
   - 本地文件存在且可读
   - 预设命令由项目维护者验证

### 6.2 约束

1. **技术约束**：
   - 实现语言：Python 3.8+
   - 依赖管理：通过 requirements.txt 或 pyproject.toml
   - 执行方式：作为独立 CLI 工具被调用

2. **性能约束**：
   - 单次安装时间 < 30 秒
   - 不阻塞用户其他操作

3. **安全约束**：
   - 不自动执行未验证的脚本
   - 不修改用户源代码
   - 只操作 `.claude/` 目录

4. **兼容性约束**：
   - 支持 Claude Code 规范的命令格式
   - 不支持不兼容的命令格式
   - 跨平台支持（Windows、macOS、Linux）

### 6.3 依赖关系

1. **外部依赖**：
   - Python 3.8+ 运行环境
   - Git 命令行工具（用于克隆仓库）
   - 网络连接（用于访问远程资源）

2. **Python 包依赖**：
   - `click` 或 `argparse`：命令行参数解析
   - `requests`：HTTP 请求（可选）
   - `GitPython` 或 `pygit2`：Git 操作（可选，也可调用 git 命令）
   - `PyYAML`：YAML 解析（用于 frontmatter）
   - `rich` 或 `colorama`：终端美化输出（可选）

3. **内部依赖**：
   - `.claude/` 目录结构
   - Claude Code CLI 框架

---

## 7. 边界与排除

### 7.1 功能边界

**包含**：
- 命令安装和卸载
- 命令更新
- 命令列表和查询
- 模板文件管理
- 配置文件生成

**不包含**：
- 命令开发工具
- 命令测试框架
- 命令市场或搜索功能
- 命令评分或评论系统

### 7.2 技术边界

**支持**：
- Markdown 格式的命令文件
- Git 仓库作为命令来源
- 本地文件系统作为命令来源
- 预设命令名称

**不支持**：
- 二进制命令文件
- 需要编译的命令
- 非标准格式的命令文件

---

## 8. 风险与缓解

### 8.1 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 命令来源不可靠 | 高 | 中 | 验证来源、提供安装警告 |
| 文件冲突处理 | 中 | 中 | 提供冲突解决策略 |
| 版本兼容性 | 中 | 中 | 记录版本、支持回滚 |

### 8.2 用户体验风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 安装失败困扰用户 | 高 | 低 | 提供清晰的错误消息和解决建议 |
| 命令卸载不完整 | 中 | 低 | 完整的资源跟踪和清理 |
| 更新导致配置丢失 | 高 | 中 | 备份配置、智能合并 |

---

## 9. 未来增强

### 9.1 潜在功能

1. **命令市场**：
   - 浏览和搜索可用命令
   - 评分和评论系统
   - 下载统计

2. **依赖管理**：
   - 自动解析命令依赖
   - 批量安装依赖命令
   - 版本冲突检测

3. **命令开发工具**：
   - 命令脚手架
   - 命令测试工具
   - 命令打包工具

4. **团队协作**：
   - 共享命令配置
   - 团队命令库
   - 统一命令版本

---

## 10. 附录

### 10.1 术语表

| 术语 | 定义 |
|------|------|
| 命令文件 | Claude Code 自定义命令的 Markdown 文件 |
| 模板文件 | 命令使用的模板资源文件 |
| frontmatter | Markdown 文件顶部的元数据区域 |
| 命令来源 | 命令文件的存储位置（Git 仓库、本地路径等） |

### 10.2 参考资料

- [Claude Code 自定义命令文档](https://code.claude.com/docs/en/slash-commands)
- [项目宪章](.specify/memory/constitution.md)
- [CLAUDE.md](CLAUDE.md)

---

## 11. 实现架构

### 11.1 技术选型

**核心实现语言**: Python 3.8+

**选型理由**:
- ✅ 跨平台兼容性最佳（Windows、macOS、Linux）
- ✅ 丰富的标准库和第三方库支持
- ✅ 强大的文件操作和错误处理能力
- ✅ 易于实现复杂的 Git 操作和配置管理
- ✅ 优秀的可测试性和可维护性
- ✅ 符合用户的明确需求

### 11.2 项目结构

```
command-install/
├── cli.py                 # 命令行入口（使用 click 或 argparse）
├── core/
│   ├── installer.py       # 安装逻辑
│   ├── source_parser.py   # 来源解析（Git/本地/预设）
│   ├── file_handler.py    # 文件操作和冲突处理
│   └── config_manager.py  # 配置文件管理
├── utils/
│   ├── git_helper.py      # Git 操作封装
│   ├── validator.py       # 文件验证
│   └── backup.py          # 备份和回滚
├── models/
│   └── command.py         # 命令元数据模型
├── requirements.txt       # Python 依赖
└── setup.py               # 安装脚本（可选）
```

### 11.3 集成方式

**方式 1：直接运行 Python 脚本（推荐）**
```bash
# 开发模式直接运行
python command-install/cli.py install <source>

# 或使用 python -m
python -m command-install.cli install <source>
```

**方式 2：安装为 Python 包**
```bash
# 使用 uv 安装到当前环境
uv pip install -e .

# 安装后可直接调用
command-install install <source>
```

**方式 3：打包为可执行文件（生产环境）**
```bash
# 使用 PyInstaller 打包
pyinstaller --onefile command-install/cli.py

# 生成的可执行文件
./command-install install <source>  # Linux/macOS
command-install.exe install <source>  # Windows
```

**推荐**:
- 开发测试：方式 1（直接运行）
- 日常使用：方式 2（uv 安装）
- 分发部署：方式 3（可执行文件）

### 11.4 关键实现细节

**来源检测算法**:
```python
def detect_source_type(source: str) -> str:
    """启发式检测来源类型"""
    if source.startswith(('./', '../', '/', '~')) or source.endswith('.md'):
        return 'local'
    if source.startswith(('https://', 'git@', 'git://')):
        return 'git'
    return 'preset'
```

**冲突处理策略**:
```python
CONFLICT_STRATEGIES = {
    'skip': '跳过冲突文件',
    'backup': '备份后覆盖',
    'force': '强制覆盖',
    'ask': '交互式询问',
}
```

**性能优化**:
- 使用 `git clone --depth 1` 浅克隆（节省 93% 时间）
- 并行文件操作（使用 `concurrent.futures`）
- 缓存已克隆的仓库

---

**文档状态**: ✅ 规范完成（已澄清技术栈和集成方式）
**下一步**: 执行 `/speckit.plan` 生成实现计划
**创建日期**: 2025-01-03
**最后更新**: 2025-01-03（添加技术栈和架构澄清）
**作者**: Repo Wiki Generator 项目团队
