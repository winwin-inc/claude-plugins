# 增量更新功能测试计划

**版本**: 3.1.0
**创建日期**: 2026-01-07
**状态**: 进行中

---

## 测试策略概述

本测试计划覆盖 Wiki Generator v3.1.0 增量更新功能的所有关键组件：

1. **变更检测层** - Git diff 分析和哈希值计算
2. **智能合并层** - 区域标记识别和手动编辑保护
3. **元数据追踪层** - 动态路径计算和版本管理
4. **端到端集成** - 完整的增量更新流程

### 测试原则

- ✅ **纯 Bash 实现** - 遵循项目架构，使用 Bash + 内联 Python
- ✅ **自包含测试** - 每个测试独立运行，无需外部依赖
- ✅ **快速执行** - 测试应该在几秒内完成
- ✅ **清晰反馈** - 失败测试提供明确的错误信息

---

## 测试覆盖范围

### 1. 变更检测测试 (test_change_detection.sh)

#### 1.1 Git diff 分析测试
- **目标**: 验证 Git diff 能正确检测变更文件
- **场景**:
  - 修改现有文件
  - 添加新文件
  - 删除文件
- **验证**:
  - 变更文件列表正确
  - Commit hash 正确
  - 基准 commit 正确

#### 1.2 哈希计算测试
- **目标**: 验证 SHA256 哈希计算的正确性和一致性
- **场景**:
  - 同一文件多次计算（一致性）
  - 不同内容计算（差异性）
  - 排除注释和空行
- **验证**:
  - 相同内容产生相同哈希
  - 不同内容产生不同哈希
  - 注释被正确排除

#### 1.3 排除模式测试
- **目标**: 验证测试和 mock 文件被正确排除
- **场景**:
  - 创建测试文件（tests/）
  - 创建 mock 文件（mocks/）
  - 创建源代码文件（src/）
- **验证**:
  - 测试文件在变更列表中
  - 后续处理中可被过滤

#### 1.4 空变更测试
- **目标**: 验证无变更时正确处理
- **场景**: 不做任何修改
- **验证**: 返回空变更列表

---

### 2. 智能合并测试 (test_smart_merge.sh)

#### 2.1 区域提取测试
- **目标**: 验证正确提取标记区域
- **场景**:
  - 单区域文档
  - 多区域文档
  - 嵌套标记
- **验证**:
  - 区域名称正确提取
  - 区域内容正确提取
  - 多个区域独立识别

#### 2.2 手动编辑检测测试
- **目标**: 验证手动编辑标记识别
- **场景**:
  - MANUAL-EDIT 标记
  - KEEP 标记
  - 无标记情况
- **验证**:
  - 正确识别 MANUAL-EDIT
  - 正确识别 KEEP
  - 无标记时返回 false

#### 2.3 相似度计算测试
- **目标**: 验证内容相似度算法
- **场景**:
  - 高相似度内容
  - 低相似度内容
  - 完全相同内容
- **验证**:
  - 相似度在 0.0-1.0 范围内
  - 相似度阈值（0.8）正确应用

#### 2.4 合并策略测试
- **目标**: 验证不同合并策略
- **场景**:
  - 简单合并（无标记）
  - 保留手动编辑（有标记）
  - 相似度低于阈值
- **验证**:
  - 无标记时使用新内容
  - 有标记时保留旧内容
  - 低相似度时保留旧内容

---

### 3. 集成测试 (test_incremental_updates.sh)

#### 3.1 仓库管理测试
- **目标**: 验证测试仓库的创建和清理
- **场景**:
  - 创建临时 Git 仓库
  - 初始化文件结构
  - 清理临时仓库
- **验证**:
  - Git 仓库正确创建
  - 初始文件存在
  - 清理后无残留

#### 3.2 变更检测集成测试
- **目标**: 验证完整的变更检测流程
- **场景**:
  - 修改文件
  - 提交变更
  - 运行变更检测
- **验证**:
  - 检测到变更文件
  - Commit hash 正确

#### 3.3 哈希追踪测试
- **目标**: 验证文件哈希追踪机制
- **场景**:
  - 计算初始哈希
  - 修改文件
  - 计算新哈希
- **验证**:
  - 哈希值正确更新
  - 不同内容产生不同哈希

#### 3.4 元数据路径测试
- **目标**: 验证动态路径计算
- **场景**:
  - 默认 output_dir
  - 自定义 output_dir
- **验证**:
  - 路径格式正确
  - 支持变量替换

#### 3.5 配置迁移测试
- **目标**: 验证配置自动迁移
- **场景**:
  - v2.0.0 配置文件
  - 运行迁移函数
- **验证**:
  - 版本更新为 v3.1.0
  - 新配置项添加
  - 旧配置保留

#### 3.6 排除模式验证测试
- **目标**: 验证排除模式在完整流程中工作
- **场景**:
  - 创建混合文件（源码 + 测试 + mock）
  - 运行变更检测
- **验证**:
  - 所有文件都被检测到
  - 可正确过滤排除文件

#### 3.7 区域标记验证测试
- **目标**: 验证区域标记格式
- **场景**:
  - 检查 START 标记
  - 检查 END 标记
  - 多个区域
- **验证**:
  - 标记格式正确
  - 成对出现

---

## 测试环境要求

### 必需工具
- Bash 4.0+
- Python 3.11+
- Git 2.0+

### 可选工具
- jq (JSON 处理，有 Python fallback)

### 环境变量
- `WIKI_CONFIG`: 配置文件路径（可选，默认 .claude/wiki-config.json）
- `PROJECT_ROOT`: 项目根目录（自动检测）

---

## 运行测试

### 运行所有测试
```bash
# 在项目根目录
cd /path/to/repo-wiki

# 运行所有测试
for test in tests/test_*.sh; do
    echo "Running $test..."
    bash "$test"
done
```

### 运行单个测试文件
```bash
# 变更检测测试
bash tests/test_change_detection.sh

# 智能合并测试
bash tests/test_smart_merge.sh

# 集成测试
bash tests/test_incremental_updates.sh
```

### 运行特定测试
```bash
# 编辑测试文件，注释掉不需要的测试
# 然后运行
bash tests/test_change_detection.sh
```

---

## CI/CD 集成

### GitHub Actions 示例
```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Run tests
        run: |
          for test in tests/test_*.sh; do
            bash "$test"
          done
```

### GitLab CI 示例
```yaml
test:
  script:
    - for test in tests/test_*.sh; do bash "$test"; done
```

---

## 测试结果解读

### 成功输出示例
```
=========================================
变更检测单元测试
========================================

  Git diff 分析 ... ✓ PASS
  哈希计算一致性 ... ✓ PASS
  哈希计算差异性 ... ✓ PASS
  排除模式过滤 ... ✓ PASS
  空变更检测 ... ✓ PASS

=========================================
测试摘要
=========================================
总计:   5
通过:   5
失败:   0
=========================================
所有测试通过！
```

### 失败输出示例
```
=========================================
智能合并单元测试
========================================

  区域提取 ... ✓ PASS
  手动编辑检测 ... ✗ FAIL
  ❌Assertion failed: Should detect MANUAL-EDIT marker

=========================================
测试摘要
=========================================
总计:   2
通过:   1
失败:   1
=========================================
有测试失败
```

---

## 故障排除

### 常见问题

#### 1. 测试仓库创建失败
**症状**: `setup_test_repo` 返回空或错误

**解决方案**:
```bash
# 检查 mktemp 命令
mktemp -d

# 检查 git 命令
git --version

# 检查权限
ls -la /tmp
```

#### 2. Python 内联代码失败
**症状**: 测试中 Python 代码报错

**解决方案**:
```bash
# 验证 Python 版本
python3 --version

# 测试内联 Python
python3 - <<'EOF'
import hashlib
print("Python works")
EOF
```

#### 3. Git diff 返回空
**症状**: 变更检测测试失败

**解决方案**:
```bash
# 检查 git 状态
git status

# 检查 commit 历史
git log --oneline

# 确保有变更
git diff HEAD~1 HEAD
```

---

## 测试维护

### 添加新测试
1. 在对应的测试文件中添加新函数
2. 使用 `run_test` 在 `main()` 中注册
3. 更新本测试计划文档

### 修改现有测试
1. 保持测试独立性
2. 更新测试计划文档
3. 运行完整测试套件验证

### 删除测试
1. 从 `main()` 中移除注册
2. 删除测试函数
3. 更新测试计划文档

---

## 测试指标

### 目标覆盖率
- 单元测试覆盖率: ≥ 80%
- 集成测试覆盖率: ≥ 60%
- 关键路径覆盖率: 100%

### 性能指标
- 单个测试执行时间: < 2 秒
- 完整测试套件: < 30 秒

### 质量指标
- 测试通过率: 100% (发布前)
- 测试稳定性: 连续运行 10 次无失败

---

## 后续计划

### 短期 (v3.1.0)
- ✅ 完成所有基础测试
- ✅ 测试文档完善
- ⏳ CI/CD 集成

### 中期 (v3.2.0)
- 添加性能测试
- 添加边界情况测试
- 添加并发测试

### 长期 (v4.0.0)
- 自动化测试生成
- 测试覆盖率报告
- 模糊测试

---

**维护者**: Claude Code
**最后更新**: 2026-01-07
